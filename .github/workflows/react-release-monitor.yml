name: React release monitor

on:
  schedule:
    - cron: '0 13 1 * *'
  workflow_dispatch:

jobs:
  react-release-monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Compare React release against baseline
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          node <<'NODE'
          const fs = require('node:fs');
          const path = require('node:path');

          const baselinePath = path.join('config', 'react-release-baseline.json');
          const { latestKnown } = JSON.parse(fs.readFileSync(baselinePath, 'utf8'));

          async function fetchLatestRelease() {
            const response = await fetch('https://api.github.com/repos/facebook/react/releases?per_page=20', {
              headers: {
                'User-Agent': 'react-gtm-kit-release-monitor',
                Authorization: `Bearer ${process.env.GITHUB_TOKEN}`
              }
            });

            if (!response.ok) {
              throw new Error(`GitHub API responded with ${response.status}: ${await response.text()}`);
            }

            const releases = await response.json();
            const stable = releases.find((release) => !release.prerelease && !release.draft);

            if (!stable) {
              throw new Error('No stable React releases returned from GitHub API.');
            }

            return (stable.tag_name || '').replace(/^v/, '');
          }

          function compareVersions(candidate, baseline) {
            const left = candidate.split('.').map(Number);
            const right = baseline.split('.').map(Number);
            const length = Math.max(left.length, right.length);

            for (let index = 0; index < length; index += 1) {
              const diff = (left[index] || 0) - (right[index] || 0);

              if (diff !== 0) {
                return Math.sign(diff);
              }
            }

            return 0;
          }

          async function main() {
            console.log(`Baseline React release: ${latestKnown}`);
            const latest = await fetchLatestRelease();
            console.log(`Latest stable React release: ${latest}`);

            const delta = compareVersions(latest, latestKnown);

            if (delta > 0) {
              console.log(
                `New React release detected: ${latest}. Update config/react-release-baseline.json and refresh the compatibility matrix.`
              );
              process.exit(1);
            }

            console.log('Baseline matches the latest stable React release.');
          }

          main().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE
