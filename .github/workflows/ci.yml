name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # Security audit for dependencies
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - name: Install dependencies
        run: pnpm install --ignore-scripts
      - name: Run security audit
        run: pnpm audit --audit-level=high
        continue-on-error: true
      - name: Check for high/critical vulnerabilities
        run: |
          # Run audit and capture output
          AUDIT_OUTPUT=$(pnpm audit --json 2>/dev/null || true)
          # Check for high or critical vulnerabilities
          HIGH_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
          CRITICAL_COUNT=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")
          echo "High vulnerabilities: $HIGH_COUNT"
          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          if [ "$HIGH_COUNT" != "0" ] || [ "$CRITICAL_COUNT" != "0" ]; then
            echo "::warning::Found $HIGH_COUNT high and $CRITICAL_COUNT critical vulnerabilities"
          fi

  quality:
    runs-on: ubuntu-latest
    env:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        task:
          - lint
          - typecheck
          - test
          - verify:lightweight
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - name: Install dependencies
        run: pnpm install || pnpm install --ignore-scripts
      - name: Build packages (excluding nuxt-app due to oxc-parser native binding issues)
        if: ${{ matrix.task == 'test' || matrix.task == 'typecheck' || matrix.task == 'verify:lightweight' }}
        run: pnpm -r --filter '!@gtm-kit/example-nuxt-app' build
      - name: Run ${{ matrix.task }}
        run: pnpm run ${{ matrix.task }}
      - name: Upload coverage to Codecov
        if: ${{ matrix.task == 'test' && env.CODECOV_TOKEN != '' }}
        uses: codecov/codecov-action@v4
        with:
          files: |
            packages/core/coverage/unit/lcov.info
            packages/react-modern/coverage/unit/lcov.info
            packages/react-legacy/coverage/unit/lcov.info
            packages/next/coverage/unit/lcov.info
            packages/vue/coverage/unit/lcov.info
            packages/nuxt/coverage/unit/lcov.info
            packages/svelte/coverage/unit/lcov.info
            packages/solid/coverage/unit/lcov.info
            packages/remix/coverage/unit/lcov.info
            packages/cli/coverage/unit/lcov.info
          flags: unittests
          fail_ci_if_error: false
