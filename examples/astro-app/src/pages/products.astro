---
import Layout from '../layouts/Layout.astro';

interface Product {
  id: string;
  name: string;
  price: number;
  category: string;
  brand: string;
  variant: string;
}

const products: Product[] = [
  { id: 'SKU-001', name: 'Blue T-Shirt', price: 29.99, category: 'Clothing', brand: 'GTM Apparel', variant: 'Blue/M' },
  { id: 'SKU-002', name: 'Running Shoes', price: 89.99, category: 'Footwear', brand: 'SpeedRunner', variant: 'Black/10' },
  { id: 'SKU-003', name: 'Wireless Headphones', price: 149.99, category: 'Electronics', brand: 'SoundMax', variant: 'Black' },
  { id: 'SKU-004', name: 'Laptop Stand', price: 49.99, category: 'Accessories', brand: 'DeskPro', variant: 'Silver' }
];
---

<Layout title="Products - GTM-Kit Astro Example">
  <div class="products-page" id="products-page">
    <div class="page-header">
      <h1>Products</h1>
      <p class="description">
        Full e-commerce tracking: view_item_list, select_item, view_item, add_to_cart, remove_from_cart,
        view_cart, begin_checkout, add_shipping_info, add_payment_info, purchase, refund
      </p>
      <button id="view-cart-btn" class="cart-btn" style="display: none;">View Cart (0)</button>
    </div>

    <!-- Browse View -->
    <div id="browse-view" class="product-grid">
      {products.map((product, index) => (
        <div
          class="product-card"
          data-product-id={product.id}
          data-product-name={product.name}
          data-product-price={product.price}
          data-product-category={product.category}
          data-product-brand={product.brand}
          data-product-variant={product.variant}
          data-product-index={index}
        >
          <div class="product-image">{product.brand.charAt(0)}</div>
          <h3>{product.name}</h3>
          <p class="brand">{product.brand}</p>
          <p class="price">${product.price.toFixed(2)}</p>
          <p class="category">{product.category}</p>
          <button class="add-to-cart">Add to Cart</button>
        </div>
      ))}
    </div>

    <!-- Cart View -->
    <div id="cart-view" class="checkout-panel" style="display: none;">
      <h2>Your Cart</h2>
      <div id="cart-items"></div>
      <div class="cart-summary">
        <p class="total">Total: $<span id="cart-total">0.00</span></p>
        <div class="button-row">
          <button id="continue-shopping" class="secondary">Continue Shopping</button>
          <button id="begin-checkout" class="primary">Begin Checkout</button>
        </div>
      </div>
    </div>

    <!-- Shipping View -->
    <div id="shipping-view" class="checkout-panel" style="display: none;">
      <h2>Shipping (Step 1/2)</h2>
      <div class="form-mock">
        <p>Address: 123 Main St, City, ST 12345</p>
        <p>Method: Standard Shipping ($5.99)</p>
      </div>
      <button id="add-shipping" class="primary">Continue to Payment</button>
    </div>

    <!-- Payment View -->
    <div id="payment-view" class="checkout-panel" style="display: none;">
      <h2>Payment (Step 2/2)</h2>
      <div class="form-mock">
        <p>Card: **** **** **** 4242</p>
        <p>Subtotal: $<span id="payment-subtotal">0.00</span></p>
        <p>Tax (8%): $<span id="payment-tax">0.00</span></p>
        <p>Shipping: $5.99</p>
        <p class="grand-total">Total: $<span id="payment-total">0.00</span></p>
      </div>
      <button id="complete-purchase" class="primary">Complete Purchase</button>
    </div>

    <!-- Complete View -->
    <div id="complete-view" class="checkout-panel complete" style="display: none;">
      <div class="success-icon">✓</div>
      <h2>Order Complete!</h2>
      <p class="order-id" id="order-id"></p>
      <div class="button-row">
        <button id="request-refund" class="danger">Request Refund</button>
        <button id="back-to-browse" class="primary">Continue Shopping</button>
      </div>
    </div>
  </div>

  <script>
    import { push } from '@jwiedeman/gtm-kit-astro';

    interface Product {
      id: string;
      name: string;
      price: number;
      category: string;
      brand: string;
      variant: string;
    }

    interface CartItem extends Product {
      quantity: number;
    }

    // State
    let cart: CartItem[] = [];
    let lastOrderId = '';

    // Helper functions
    const toGA4Item = (product: Product, quantity = 1, index?: number) => ({
      item_id: product.id,
      item_name: product.name,
      item_brand: product.brand,
      item_category: product.category,
      item_variant: product.variant,
      price: product.price,
      quantity,
      ...(index !== undefined && { index })
    });

    const pushEcommerce = (event: string, ecommerce: Record<string, unknown>) => {
      push({ event, ecommerce });
    };

    const getCartTotal = () => cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const getCartCount = () => cart.reduce((sum, item) => sum + item.quantity, 0);

    const showView = (viewId: string) => {
      ['browse-view', 'cart-view', 'shipping-view', 'payment-view', 'complete-view'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = id === viewId ? (id === 'browse-view' ? 'grid' : 'block') : 'none';
      });
    };

    const updateCartButton = () => {
      const btn = document.getElementById('view-cart-btn');
      const count = getCartCount();
      if (btn) {
        btn.style.display = count > 0 ? 'block' : 'none';
        btn.textContent = `View Cart (${count})`;
      }
    };

    const getProductFromCard = (card: HTMLElement): Product => ({
      id: card.dataset.productId || '',
      name: card.dataset.productName || '',
      price: parseFloat(card.dataset.productPrice || '0'),
      category: card.dataset.productCategory || '',
      brand: card.dataset.productBrand || '',
      variant: card.dataset.productVariant || ''
    });

    const renderCart = () => {
      const container = document.getElementById('cart-items');
      const totalEl = document.getElementById('cart-total');
      if (!container || !totalEl) return;

      container.innerHTML = cart.map(item => `
        <div class="cart-item" data-product-id="${item.id}">
          <div class="item-info">
            <h4>${item.name}</h4>
            <p>Qty: ${item.quantity} × $${item.price.toFixed(2)}</p>
          </div>
          <button class="remove-btn" data-product-id="${item.id}">Remove</button>
        </div>
      `).join('');

      totalEl.textContent = getCartTotal().toFixed(2);

      // Add remove listeners
      container.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const productId = (e.currentTarget as HTMLElement).dataset.productId;
          const item = cart.find(i => i.id === productId);
          if (item) {
            pushEcommerce('remove_from_cart', {
              currency: 'USD',
              value: item.price * item.quantity,
              items: [toGA4Item(item, item.quantity)]
            });
            cart = cart.filter(i => i.id !== productId);
            renderCart();
            updateCartButton();
          }
        });
      });
    };

    // Build product list for view_item_list
    const products: Product[] = Array.from(document.querySelectorAll('.product-card')).map(card =>
      getProductFromCard(card as HTMLElement)
    );

    // Track view_item_list on page load
    pushEcommerce('view_item_list', {
      item_list_id: 'products_main',
      item_list_name: 'Products Page',
      items: products.map((p, i) => toGA4Item(p, 1, i))
    });

    // Product card click - select_item and view_item
    document.querySelectorAll('.product-card').forEach((card) => {
      card.addEventListener('click', (e) => {
        if ((e.target as HTMLElement).classList.contains('add-to-cart')) return;
        const target = e.currentTarget as HTMLElement;
        const product = getProductFromCard(target);
        const index = parseInt(target.dataset.productIndex || '0');

        pushEcommerce('select_item', {
          item_list_id: 'products_main',
          item_list_name: 'Products Page',
          items: [toGA4Item(product, 1, index)]
        });
        pushEcommerce('view_item', {
          currency: 'USD',
          value: product.price,
          items: [toGA4Item(product)]
        });
      });
    });

    // Add to cart
    document.querySelectorAll('.add-to-cart').forEach((button) => {
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        const card = (e.currentTarget as HTMLElement).closest('.product-card') as HTMLElement;
        const product = getProductFromCard(card);

        const existing = cart.find(i => i.id === product.id);
        if (existing) {
          existing.quantity += 1;
        } else {
          cart.push({ ...product, quantity: 1 });
        }

        pushEcommerce('add_to_cart', {
          currency: 'USD',
          value: product.price,
          items: [toGA4Item(product)]
        });

        updateCartButton();
      });
    });

    // View cart
    document.getElementById('view-cart-btn')?.addEventListener('click', () => {
      showView('cart-view');
      renderCart();
      pushEcommerce('view_cart', {
        currency: 'USD',
        value: getCartTotal(),
        items: cart.map((item, i) => toGA4Item(item, item.quantity, i))
      });
    });

    // Continue shopping
    document.getElementById('continue-shopping')?.addEventListener('click', () => {
      showView('browse-view');
      updateCartButton();
    });

    // Begin checkout
    document.getElementById('begin-checkout')?.addEventListener('click', () => {
      pushEcommerce('begin_checkout', {
        currency: 'USD',
        value: getCartTotal(),
        items: cart.map(item => toGA4Item(item, item.quantity))
      });
      showView('shipping-view');
    });

    // Add shipping
    document.getElementById('add-shipping')?.addEventListener('click', () => {
      pushEcommerce('add_shipping_info', {
        currency: 'USD',
        value: getCartTotal(),
        shipping_tier: 'Standard',
        items: cart.map(item => toGA4Item(item, item.quantity))
      });
      showView('payment-view');

      // Update payment view totals
      const total = getCartTotal();
      const tax = total * 0.08;
      document.getElementById('payment-subtotal')!.textContent = total.toFixed(2);
      document.getElementById('payment-tax')!.textContent = tax.toFixed(2);
      document.getElementById('payment-total')!.textContent = (total + tax + 5.99).toFixed(2);
    });

    // Complete purchase
    document.getElementById('complete-purchase')?.addEventListener('click', () => {
      const total = getCartTotal();
      const orderId = `TXN-${Date.now()}`;
      lastOrderId = orderId;

      pushEcommerce('add_payment_info', {
        currency: 'USD',
        value: total,
        payment_type: 'Credit Card',
        items: cart.map(item => toGA4Item(item, item.quantity))
      });

      pushEcommerce('purchase', {
        transaction_id: orderId,
        currency: 'USD',
        value: total,
        tax: total * 0.08,
        shipping: 5.99,
        items: cart.map(item => toGA4Item(item, item.quantity))
      });

      cart = [];
      document.getElementById('order-id')!.textContent = orderId;
      showView('complete-view');
    });

    // Request refund
    document.getElementById('request-refund')?.addEventListener('click', () => {
      pushEcommerce('refund', {
        transaction_id: lastOrderId,
        currency: 'USD',
        value: 0
      });
      push({ event: 'refund_requested', order_id: lastOrderId });
      lastOrderId = '';
      showView('browse-view');
      updateCartButton();
    });

    // Back to browse
    document.getElementById('back-to-browse')?.addEventListener('click', () => {
      showView('browse-view');
      updateCartButton();
    });
  </script>
</Layout>

<style>
  .products-page {
    padding: 1rem 0;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .page-header h1 {
    margin: 0 0 0.5rem;
  }

  .description {
    color: #666;
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .cart-btn {
    background: #27ae60;
    color: white;
  }

  .product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
  }

  .product-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.25rem;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .product-image {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: bold;
    margin-bottom: 0.75rem;
  }

  .product-card h3 {
    margin: 0 0 0.25rem;
    font-size: 1rem;
  }

  .brand {
    color: #6c757d;
    font-size: 0.8rem;
    margin: 0 0 0.25rem;
  }

  .price {
    font-size: 1.125rem;
    font-weight: 600;
    color: #27ae60;
    margin: 0 0 0.25rem;
  }

  .category {
    color: #6c757d;
    font-size: 0.75rem;
    margin: 0 0 0.75rem;
  }

  .product-card button {
    width: 100%;
    background: #3498db;
    color: white;
    font-size: 0.875rem;
  }

  .checkout-panel {
    background: #f8f9fa;
    padding: 2rem;
    border-radius: 8px;
    max-width: 500px;
  }

  .checkout-panel h2 {
    margin: 0 0 1rem;
  }

  .cart-summary {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 2px solid #e9ecef;
  }

  .total {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .button-row {
    display: flex;
    gap: 0.5rem;
  }

  .button-row button {
    flex: 1;
  }

  .primary {
    background: #27ae60;
    color: white;
  }

  .secondary {
    background: #6c757d;
    color: white;
  }

  .danger {
    background: #e74c3c;
    color: white;
  }

  .form-mock {
    background: white;
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
  }

  .form-mock p {
    margin: 0.25rem 0;
    color: #666;
  }

  .grand-total {
    font-weight: 600;
    color: #333;
    margin-top: 0.5rem !important;
  }

  .checkout-panel.complete {
    text-align: center;
  }

  .success-icon {
    width: 80px;
    height: 80px;
    background: #27ae60;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    margin: 0 auto 1rem;
  }

  .order-id {
    color: #666;
    font-family: monospace;
    margin-bottom: 1rem;
  }
</style>

<style is:global>
  .cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: white;
    border-radius: 4px;
    margin-bottom: 0.5rem;
  }

  .cart-item .item-info h4 {
    margin: 0 0 0.25rem;
  }

  .cart-item .item-info p {
    margin: 0;
    color: #666;
    font-size: 0.875rem;
  }

  .cart-item .remove-btn {
    background: #e74c3c;
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
  }
</style>
